summary(hhUsedW$wgtRatio)
cat("  ----> Share of Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedW),fill=T)
#
## -- Households not selected -- ##
setkey(hhUsed,serial); setkey(wgt,serial)
notSelected <- merge(wgt,hhUsed,by="serial",all.x=T); nrow(notSelected)
notSelected <-  notSelected[is.na(Obs)]
cat("  --> ",nrow(notSelected),"households were not selected in the enumeration",fill=T)
# -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -
## -- Review WFH HHs replicated many times -- ##
chkUsed <- copy(hhUsedW)
usedMany <- chkUsed[Obs>2300]; nrow(usedMany)
head(usedMany,10)
usedMany[,wtperfin:=NULL]
## -- see if replication is focuesed on a few puma-hhvtype combos -- ##
setkey(usedMany,serial); setkey(enumTrips,serial)
manyReps <- enumTrips[usedMany]; nrow(manyReps)
biggest <- manyReps[serial==70056576]; nrow(biggest)
summary(biggest$wfh)
bigPuma <- biggest[,.(Recs=.N),by=.(puma)][order(-Recs)]; nrow(bigPuma)
summary(bigPuma$Recs)
bigHhvtype <- biggest[,.(Recs=.N),by=.(HHVTYPE)][order(-Recs)]; nrow(bigHhvtype)
summary(bigHhvtype$Recs)
setwd(baseDir)
## -- Verify zero-worker HHS have not been selected as WFH HHs -- ##
wfhStatus <- fread(in1b); nrow(wfhStatus)
setnames(wfhStatus,c("V1","V2","V3","V4"),c("pserial2","wfhFlag","wfhWkrs","tcNot"))
wfhStatus[,indexLoc:=.I]
setkey(wfhStatus,indexLoc); setkey(popsyn,indexLoc)
review <- popsyn[wfhStatus]
badWfh <- review[wfhFlag>0 & workers==0]; nrow(badWfh)
head(biggest,10)
chk1 <- biggest[HHTYPE==1 & workers>0]
nrowchk1
nrow(chk1)
head(chk1)
pchk <- popsyn[indexLoc %in% c(19,47,56,4345)]
head(pchk)
pchk <- popsyn[indexLoc %in% c(19,47,56,4345,4359,8536)]
pchk
summary(chk1$wfh)
head(popsyn)
## Review_enumerated_trips.R
##  Craig Heither, rev. 03-11-2021
##
##  Script to review Trip Generation model work from home changes.
##   Part 1: QC of process input and output files to verify process works as intended.
##   Part 2: Review Rare households and zero-trip households in enumerated data and compare to weighted MDT data.
##   Part 3: Compare trip rates between WFH and non-WFH households.
#====================================================================================
#baseDir = "C:/craig_temp/TBM_update_c20q4_200_WFHinteg/Database/tg/fortran"		##-- mod16
#baseDir = "E:/cmh/TBM_update_c20q4_200_newWgts/Database/tg/fortran"			##-- mod01 new RSG weights
#baseDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/model setup template/TBM_update_c20q4_200/Database/tg/fortran"
#baseDir = "C:/cmh/TBM_update_c20q4_200_HiLowChange/Database/tg/fortran"		##-- mod01
#baseDir = "F:/cmh/TBMnew/cmap_trip-based_model/Database/tg/fortran"		#			#-- mod23 [TBM update 2019 base]
#baseDir = "F:/cmh/RSP_2019_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
baseDir = "F:/cmh/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
#baseDir = "M:/proj1/cmh/test/TBMnew3/cmap_trip-based_model/Database/tg/fortran"		##-- TBM update 2019 base run on mod05 -- reports the same
#baseDir = "M:/proj1/cmh/test/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"	##-- run on mod05 -- reports the same
in1 = "POPSYN_HH.CSV"
in2 = "HI_HHENUM_TRIP_OUT.TXT"
in3 = "HI_HHENUM_IN.TXT"
in4 = "HHID_wfh2.csv"
in4b = "HHID_choices2.csv"
in5 = "HHID_wfh1.csv"
in5b = "HHID_choices1.csv"
in1b = "HH_WFH_STATUS.CSV"
inDir1 = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/survey prep/data"
in6 = "Final_MyDailyTravel_weights.csv"										##-- new RSG weights
in7 = "GEOG_IN.TXT"
outDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/TG_model_update/Work from Home"
outFile1 = "wfh_rate_compare.csv"
outFile2 = "wfh_shop_rate_compare.csv"
outFile3 = "wfh_work_rate_compare.csv"
outFile4 = "wfh_school_rate_compare.csv"
outFile5 = "HH_trip_rates_by_county.csv"
outFileN1 = "tbm_hbw1.csv"
outFileN2 = "tbm_hbw2.csv"
outFileN3 = "tbm_hbw3.csv"
outFileN4 = "tbm_hbo1.csv"
outFileN5 = "tbm_hbo2.csv"
outFileN6 = "tbm_hbo3.csv"
outFileN7 = "tbm_hshp1.csv"
outFileN8 = "tbm_hshp2.csv"
outFileN9 = "tbm_hshp3.csv"
outFileN10 = "tbm_nhb1.csv"
outFileN11 = "tbm_nhb2.csv"
outFileN12 = "tbm_nhb3.csv"
outFileN13 = "tbm_all.csv"
regmed = 68300																##-- regional median HH income (2019 dollars)
wrkThresh = 16																##-- worker trip 99th percentile	18
nonwrkThresh = 14															##-- nonworker trip 99th percentile	16
chldThresh = 10																##-- child trip 99th percentile		12
#====================================================================================
loadPackage <- function (package) {
if(!package %in% .packages(all = TRUE)) {
install.packages(package, repos = "http://cran.r-project.org")
}
eval(parse(text=paste("library(", package, ")", sep="")))
}
loadPackage("data.table")
loadPackage("bit64")
loadPackage("vroom")
#====================================================================================
options(scipen=999)															## -- turn off scientific notation
setwd(baseDir)
## -- Review POPSYN_HH file -- ##
popsyn <- fread(in1); nrow(popsyn)
setnames(popsyn,c("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10","V11","V12","V13"),
c("subzone","HHTYPE","vehAcs","pserial","stPuma","rowColumn","adults","workers","children","incCat","ageCat","HHVTYPEacs","income"))
summary(popsyn$subzone); summary(popsyn$HHTYPE); summary(popsyn$pserial); summary(popsyn$stPuma); summary(popsyn$HHVTYPEacs)
chk <- popsyn[113]
## -- Review HI_HHENUM_TRIP_OUT file -- ##
enumTrips <- as.data.table(vroom_fwf(in2, fwf_cols(subzone=5, puma=7, HHTYPE=4, HHVTYPE=4, vehModel=2, rowColumn=2, serial=8, adults=3, workers=3, nonworkers=3,
children=3, child1215=3, vehAcs=3, 	trip1=3, trip2=3, trip3=3, trip4=3, trip5=3, trip6=3, trip7=3, trip8=3, trip9=3, trip10=3, trip11=3, trip12=3, trip13=3,
trip14=3, trip15=3, trip16=3, 	trip17=3, trip18=3, trip19=3, trip20=3, trip21=3, trip22=3, trip23=3, trip24=3, trip25=3, trip26=3, trip27=3, trip28=3,
trip29=3, trip30=3, trip31=3, trip32=3, trip33=3, trip34=3, trip35=3, trip36=3, trip37=3, trip38=3, trip39=3, trip40=3, trip41=3, trip42=3, trip43=3,
trip44=3, trip45=3, trip46=3, trip47=3, trip48=3, trip49=3, pserial=13, matchCat=1, wfh=1, indexLoc=8)))
nrow(enumTrips)
summary(enumTrips$subzone); summary(enumTrips$puma); summary(enumTrips$HHTYPE); summary(enumTrips$HHVTYPE); summary(enumTrips$vehModel)
summary(enumTrips$rowColumn); summary(enumTrips$serial); summary(enumTrips$indexLoc)
## -- Merge income to enumTrips & review high/low income work trips -- ##
popsyn[,indexLoc:=.I]
popinc <- popsyn[,list(indexLoc,income)]
setkey(popinc,indexLoc); setkey(enumTrips,indexLoc)
enumTrips <- enumTrips[popinc]; nrow(enumTrips)
cat("  --> ",nrow(enumTrips[income<regmed & trip2>0]),"records where HH income is under the regional median but there are high income work trips",fill=T)
cat("  --> ",nrow(enumTrips[income>=regmed & trip1>0]),"records where HH income is above the regional median but there are low income work trips",fill=T)
chk <- enumTrips[serial==0]; nrow(chk)
chk2 <- enumTrips[indexLoc==113]
chk3 <- enumTrips[indexLoc==3729002]
## -- Review HI_HHENUM_IN file -- ##
mdt <- fread(in3); nrow(mdt)
setnames(mdt,c("V3"),c("serial"))
summary(mdt$V1); summary(mdt$V2); summary(mdt$serial)
#====================================================================================
## -- Determine frequency of Households being selected -- ##
setwd(inDir1)
wgt <- fread(in6)
wgt <- wgt[!duplicated(sampno),list(sampno,wtperfin)]
setnames(wgt,c("sampno"),c("serial"))
setkey(wgt,serial); setkey(enumTrips,serial)
enumTrips <- merge(enumTrips,wgt,by="serial",all.x=T); nrow(enumTrips)
#
hhUsed <- enumTrips[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]	## -- HHs used in trip enumeration
hhUsed[,wgtRatio:=Obs/wtperfin]											## -- ratio of number of times selected/ survey weight
cat("  --> In a representative sample each household would be used",round(nrow(enumTrips)/nrow(mdt)),"times",fill=T)
summary(hhUsed$Obs)
summary(hhUsed$wtperfin)
summary(hhUsed$wgtRatio)
#
s1 <- enumTrips[wfh==0]
hhUsedNonW <- s1[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]		## -- HHs used in trip enumeration (NON-WFH)
hhUsedNonW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Non-Work from Home households",fill=T)
summary(hhUsedNonW$Obs)
summary(hhUsedNonW$wtperfin)
summary(hhUsedNonW$wgtRatio)
cat("  ----> Share of Non-Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedNonW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedNonW),fill=T)
#
s2 <- enumTrips[wfh==1]
hhUsedW <- s2[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]			## -- HHs used in trip enumeration (WFH)
hhUsedW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Work from Home households",fill=T)
summary(hhUsedW$Obs)
summary(hhUsedW$wtperfin)
summary(hhUsedW$wgtRatio)
cat("  ----> Share of Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedW),fill=T)
#
## -- Households not selected -- ##
setkey(hhUsed,serial); setkey(wgt,serial)
notSelected <- merge(wgt,hhUsed,by="serial",all.x=T); nrow(notSelected)
notSelected <-  notSelected[is.na(Obs)]
cat("  --> ",nrow(notSelected),"households were not selected in the enumeration",fill=T)
## -- Review WFH HHs replicated many times -- ##
chkUsed <- copy(hhUsedW)
usedMany <- chkUsed[Obs>2300]; nrow(usedMany)
head(usedMany,10)
usedMany[,wtperfin:=NULL]
## -- see if replication is focuesed on a few puma-hhvtype combos -- ##
setkey(usedMany,serial); setkey(enumTrips,serial)
manyReps <- enumTrips[usedMany]; nrow(manyReps)
biggest <- manyReps[serial==70056576]; nrow(biggest)
head(biggest)
summary(biggest$pserial)
chkps <- popsyn[indexLoc==19]
chkps
## Review_enumerated_trips.R
##  Craig Heither, rev. 03-11-2021
##
##  Script to review Trip Generation model work from home changes.
##   Part 1: QC of process input and output files to verify process works as intended.
##   Part 2: Review Rare households and zero-trip households in enumerated data and compare to weighted MDT data.
##   Part 3: Compare trip rates between WFH and non-WFH households.
#====================================================================================
#baseDir = "C:/craig_temp/TBM_update_c20q4_200_WFHinteg/Database/tg/fortran"		##-- mod16
#baseDir = "E:/cmh/TBM_update_c20q4_200_newWgts/Database/tg/fortran"			##-- mod01 new RSG weights
#baseDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/model setup template/TBM_update_c20q4_200/Database/tg/fortran"
#baseDir = "C:/cmh/TBM_update_c20q4_200_HiLowChange/Database/tg/fortran"		##-- mod01
#baseDir = "F:/cmh/TBMnew/cmap_trip-based_model/Database/tg/fortran"		#			#-- mod23 [TBM update 2019 base]
#baseDir = "F:/cmh/RSP_2019_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
baseDir = "F:/cmh/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
#baseDir = "M:/proj1/cmh/test/TBMnew3/cmap_trip-based_model/Database/tg/fortran"		##-- TBM update 2019 base run on mod05 -- reports the same
#baseDir = "M:/proj1/cmh/test/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"	##-- run on mod05 -- reports the same
in1 = "POPSYN_HH.CSV"
in2 = "HI_HHENUM_TRIP_OUT.TXT"
in3 = "HI_HHENUM_IN.TXT"
in4 = "HHID_wfh2.csv"
in4b = "HHID_choices2.csv"
in5 = "HHID_wfh1.csv"
in5b = "HHID_choices1.csv"
in1b = "HH_WFH_STATUS.CSV"
inDir1 = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/survey prep/data"
in6 = "Final_MyDailyTravel_weights.csv"										##-- new RSG weights
in7 = "GEOG_IN.TXT"
outDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/TG_model_update/Work from Home"
outFile1 = "wfh_rate_compare.csv"
outFile2 = "wfh_shop_rate_compare.csv"
outFile3 = "wfh_work_rate_compare.csv"
outFile4 = "wfh_school_rate_compare.csv"
outFile5 = "HH_trip_rates_by_county.csv"
outFileN1 = "tbm_hbw1.csv"
outFileN2 = "tbm_hbw2.csv"
outFileN3 = "tbm_hbw3.csv"
outFileN4 = "tbm_hbo1.csv"
outFileN5 = "tbm_hbo2.csv"
outFileN6 = "tbm_hbo3.csv"
outFileN7 = "tbm_hshp1.csv"
outFileN8 = "tbm_hshp2.csv"
outFileN9 = "tbm_hshp3.csv"
outFileN10 = "tbm_nhb1.csv"
outFileN11 = "tbm_nhb2.csv"
outFileN12 = "tbm_nhb3.csv"
outFileN13 = "tbm_all.csv"
regmed = 68300																##-- regional median HH income (2019 dollars)
wrkThresh = 16																##-- worker trip 99th percentile	18
nonwrkThresh = 14															##-- nonworker trip 99th percentile	16
chldThresh = 10																##-- child trip 99th percentile		12
#====================================================================================
loadPackage <- function (package) {
if(!package %in% .packages(all = TRUE)) {
install.packages(package, repos = "http://cran.r-project.org")
}
eval(parse(text=paste("library(", package, ")", sep="")))
}
loadPackage("data.table")
loadPackage("bit64")
loadPackage("vroom")
#====================================================================================
options(scipen=999)															## -- turn off scientific notation
setwd(baseDir)
## -- Review POPSYN_HH file -- ##
popsyn <- fread(in1); nrow(popsyn)
setnames(popsyn,c("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10","V11","V12","V13"),
c("subzone","HHTYPE","vehAcs","pserial","stPuma","rowColumn","adults","workers","children","incCat","ageCat","HHVTYPEacs","income"))
summary(popsyn$subzone); summary(popsyn$HHTYPE); summary(popsyn$pserial); summary(popsyn$stPuma); summary(popsyn$HHVTYPEacs)
chk <- popsyn[113]
## -- Review HI_HHENUM_TRIP_OUT file -- ##
enumTrips <- as.data.table(vroom_fwf(in2, fwf_cols(subzone=5, puma=7, HHTYPE=4, HHVTYPE=4, vehModel=2, rowColumn=2, serial=8, adults=3, workers=3, nonworkers=3,
children=3, child1215=3, vehAcs=3, 	trip1=3, trip2=3, trip3=3, trip4=3, trip5=3, trip6=3, trip7=3, trip8=3, trip9=3, trip10=3, trip11=3, trip12=3, trip13=3,
trip14=3, trip15=3, trip16=3, 	trip17=3, trip18=3, trip19=3, trip20=3, trip21=3, trip22=3, trip23=3, trip24=3, trip25=3, trip26=3, trip27=3, trip28=3,
trip29=3, trip30=3, trip31=3, trip32=3, trip33=3, trip34=3, trip35=3, trip36=3, trip37=3, trip38=3, trip39=3, trip40=3, trip41=3, trip42=3, trip43=3,
trip44=3, trip45=3, trip46=3, trip47=3, trip48=3, trip49=3, pserial=13, matchCat=1, wfh=1, indexLoc=8)))
nrow(enumTrips)
summary(enumTrips$subzone); summary(enumTrips$puma); summary(enumTrips$HHTYPE); summary(enumTrips$HHVTYPE); summary(enumTrips$vehModel)
summary(enumTrips$rowColumn); summary(enumTrips$serial); summary(enumTrips$indexLoc)
## -- Merge income to enumTrips & review high/low income work trips -- ##
popsyn[,indexLoc:=.I]
popinc <- popsyn[,list(indexLoc,income)]
setkey(popinc,indexLoc); setkey(enumTrips,indexLoc)
enumTrips <- enumTrips[popinc]; nrow(enumTrips)
cat("  --> ",nrow(enumTrips[income<regmed & trip2>0]),"records where HH income is under the regional median but there are high income work trips",fill=T)
cat("  --> ",nrow(enumTrips[income>=regmed & trip1>0]),"records where HH income is above the regional median but there are low income work trips",fill=T)
chk <- enumTrips[serial==0]; nrow(chk)
chk2 <- enumTrips[indexLoc==113]
chk3 <- enumTrips[indexLoc==3729002]
## -- Review HI_HHENUM_IN file -- ##
mdt <- fread(in3); nrow(mdt)
setnames(mdt,c("V3"),c("serial"))
summary(mdt$V1); summary(mdt$V2); summary(mdt$serial)
#====================================================================================
## -- Determine frequency of Households being selected -- ##
setwd(inDir1)
wgt <- fread(in6)
wgt <- wgt[!duplicated(sampno),list(sampno,wtperfin)]
setnames(wgt,c("sampno"),c("serial"))
setkey(wgt,serial); setkey(enumTrips,serial)
enumTrips <- merge(enumTrips,wgt,by="serial",all.x=T); nrow(enumTrips)
#
hhUsed <- enumTrips[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]	## -- HHs used in trip enumeration
hhUsed[,wgtRatio:=Obs/wtperfin]											## -- ratio of number of times selected/ survey weight
cat("  --> In a representative sample each household would be used",round(nrow(enumTrips)/nrow(mdt)),"times",fill=T)
summary(hhUsed$Obs)
summary(hhUsed$wtperfin)
summary(hhUsed$wgtRatio)
#
s1 <- enumTrips[wfh==0]
hhUsedNonW <- s1[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]		## -- HHs used in trip enumeration (NON-WFH)
hhUsedNonW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Non-Work from Home households",fill=T)
summary(hhUsedNonW$Obs)
summary(hhUsedNonW$wtperfin)
summary(hhUsedNonW$wgtRatio)
cat("  ----> Share of Non-Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedNonW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedNonW),fill=T)
#
s2 <- enumTrips[wfh==1]
hhUsedW <- s2[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]			## -- HHs used in trip enumeration (WFH)
hhUsedW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Work from Home households",fill=T)
summary(hhUsedW$Obs)
summary(hhUsedW$wtperfin)
summary(hhUsedW$wgtRatio)
cat("  ----> Share of Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedW),fill=T)
#
## -- Households not selected -- ##
setkey(hhUsed,serial); setkey(wgt,serial)
notSelected <- merge(wgt,hhUsed,by="serial",all.x=T); nrow(notSelected)
notSelected <-  notSelected[is.na(Obs)]
cat("  --> ",nrow(notSelected),"households were not selected in the enumeration",fill=T)
sum(hhUsedW$Obs)
## -- Review HHID_wfh2 file -- ##
setwd(baseDir)
wfhChoice <- fread(in4); nrow(wfhChoice)
summary(wfhChoice$V1); summary(wfhChoice$V2)
## -- Review HHID_wfh1 file -- ##
wfhChoice1 <- fread(in5); nrow(wfhChoice1)
summary(wfhChoice1$V1); summary(wfhChoice1$V2); summary(wfhChoice1$V3)
#====================================================================================
## -- Summarize types of trips -- ##
enumTrips[,wrkTrips:=trip1+trip2+trip3+trip4+trip5+trip6+trip7+trip8+trip9+trip10+trip11+trip12+trip13+
trip14+trip15+trip16+trip17+trip18+trip19+trip20]																##-- Worker trips
enumTrips[,nonwrkTrips:=trip21+trip22+trip23+trip24+trip25+trip26+trip27+trip28+trip29+trip30+trip31+trip32+trip33]	##-- NonWorker trips
enumTrips[,chdTrips:=trip34+trip35+trip36+trip37+trip38+trip39+trip40+trip41+trip42+trip43+
trip44+trip45+trip46+trip47+trip48+trip49]																		##-- Children 12-15 trips
sumTrips <- enumTrips[,.(wrkTrips=sum(wrkTrips),nonwrkTrips=sum(nonwrkTrips),chdTrips=sum(chdTrips))]
sumTrips[,totalTrips:=wrkTrips+nonwrkTrips+chdTrips]
sumTrips
## -- Review Zero Trip Households -- ##
enumTrips[,allTrips:=wrkTrips+nonwrkTrips+chdTrips]
enumTrips[allTrips==0,zeroHHs:=1L]
enumTrips[allTrips>0,zeroHHs:=0L]
cat(nrow(enumTrips[zeroHHs==1]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",nrow(enumTrips[zeroHHs==1])/nrow(enumTrips),fill=T)
cat("Non-Work From Home:",nrow(enumTrips[zeroHHs==1 & wfh==0]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",
nrow(enumTrips[zeroHHs==1 & wfh==0])/nrow(enumTrips),"(",nrow(enumTrips[wfh==0])/nrow(enumTrips),"of all households",fill=T)
cat("Work From Home:",nrow(enumTrips[zeroHHs==1 & wfh==1]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",
nrow(enumTrips[zeroHHs==1 & wfh==1])/nrow(enumTrips),"(",nrow(enumTrips[wfh==1])/nrow(enumTrips),"of all households",fill=T)
## Review_enumerated_trips.R
##  Craig Heither, rev. 03-11-2021
##
##  Script to review Trip Generation model work from home changes.
##   Part 1: QC of process input and output files to verify process works as intended.
##   Part 2: Review Rare households and zero-trip households in enumerated data and compare to weighted MDT data.
##   Part 3: Compare trip rates between WFH and non-WFH households.
#====================================================================================
#baseDir = "C:/craig_temp/TBM_update_c20q4_200_WFHinteg/Database/tg/fortran"		##-- mod16
#baseDir = "E:/cmh/TBM_update_c20q4_200_newWgts/Database/tg/fortran"			##-- mod01 new RSG weights
#baseDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/model setup template/TBM_update_c20q4_200/Database/tg/fortran"
#baseDir = "C:/cmh/TBM_update_c20q4_200_HiLowChange/Database/tg/fortran"		##-- mod01
#baseDir = "F:/cmh/TBMnew/cmap_trip-based_model/Database/tg/fortran"		#			#-- mod23 [TBM update 2019 base]
baseDir = "F:/cmh/RSP_2019_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
#baseDir = "F:/cmh/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"		##-- mod23
#baseDir = "M:/proj1/cmh/test/TBMnew3/cmap_trip-based_model/Database/tg/fortran"		##-- TBM update 2019 base run on mod05 -- reports the same
#baseDir = "M:/proj1/cmh/test/RSP_2050_template/cmap_trip-based_model/Database/tg/fortran"	##-- run on mod05 -- reports the same
in1 = "POPSYN_HH.CSV"
in2 = "HI_HHENUM_TRIP_OUT.TXT"
in3 = "HI_HHENUM_IN.TXT"
in4 = "HHID_wfh2.csv"
in4b = "HHID_choices2.csv"
in5 = "HHID_wfh1.csv"
in5b = "HHID_choices1.csv"
in1b = "HH_WFH_STATUS.CSV"
inDir1 = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/survey prep/data"
in6 = "Final_MyDailyTravel_weights.csv"										##-- new RSG weights
in7 = "GEOG_IN.TXT"
outDir = "M:/proj1/cmh/Trip-Based Model/FY20/RFP 230/TG_model_update/Work from Home"
outFile1 = "wfh_rate_compare.csv"
outFile2 = "wfh_shop_rate_compare.csv"
outFile3 = "wfh_work_rate_compare.csv"
outFile4 = "wfh_school_rate_compare.csv"
outFile5 = "HH_trip_rates_by_county.csv"
outFileN1 = "tbm_hbw1.csv"
outFileN2 = "tbm_hbw2.csv"
outFileN3 = "tbm_hbw3.csv"
outFileN4 = "tbm_hbo1.csv"
outFileN5 = "tbm_hbo2.csv"
outFileN6 = "tbm_hbo3.csv"
outFileN7 = "tbm_hshp1.csv"
outFileN8 = "tbm_hshp2.csv"
outFileN9 = "tbm_hshp3.csv"
outFileN10 = "tbm_nhb1.csv"
outFileN11 = "tbm_nhb2.csv"
outFileN12 = "tbm_nhb3.csv"
outFileN13 = "tbm_all.csv"
regmed = 68300																##-- regional median HH income (2019 dollars)
wrkThresh = 16																##-- worker trip 99th percentile	18
nonwrkThresh = 14															##-- nonworker trip 99th percentile	16
chldThresh = 10																##-- child trip 99th percentile		12
#====================================================================================
loadPackage <- function (package) {
if(!package %in% .packages(all = TRUE)) {
install.packages(package, repos = "http://cran.r-project.org")
}
eval(parse(text=paste("library(", package, ")", sep="")))
}
loadPackage("data.table")
loadPackage("bit64")
loadPackage("vroom")
#====================================================================================
options(scipen=999)															## -- turn off scientific notation
setwd(baseDir)
## -- Review POPSYN_HH file -- ##
popsyn <- fread(in1); nrow(popsyn)
setnames(popsyn,c("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10","V11","V12","V13"),
c("subzone","HHTYPE","vehAcs","pserial","stPuma","rowColumn","adults","workers","children","incCat","ageCat","HHVTYPEacs","income"))
summary(popsyn$subzone); summary(popsyn$HHTYPE); summary(popsyn$pserial); summary(popsyn$stPuma); summary(popsyn$HHVTYPEacs)
chk <- popsyn[113]
## -- Review HI_HHENUM_TRIP_OUT file -- ##
enumTrips <- as.data.table(vroom_fwf(in2, fwf_cols(subzone=5, puma=7, HHTYPE=4, HHVTYPE=4, vehModel=2, rowColumn=2, serial=8, adults=3, workers=3, nonworkers=3,
children=3, child1215=3, vehAcs=3, 	trip1=3, trip2=3, trip3=3, trip4=3, trip5=3, trip6=3, trip7=3, trip8=3, trip9=3, trip10=3, trip11=3, trip12=3, trip13=3,
trip14=3, trip15=3, trip16=3, 	trip17=3, trip18=3, trip19=3, trip20=3, trip21=3, trip22=3, trip23=3, trip24=3, trip25=3, trip26=3, trip27=3, trip28=3,
trip29=3, trip30=3, trip31=3, trip32=3, trip33=3, trip34=3, trip35=3, trip36=3, trip37=3, trip38=3, trip39=3, trip40=3, trip41=3, trip42=3, trip43=3,
trip44=3, trip45=3, trip46=3, trip47=3, trip48=3, trip49=3, pserial=13, matchCat=1, wfh=1, indexLoc=8)))
nrow(enumTrips)
summary(enumTrips$subzone); summary(enumTrips$puma); summary(enumTrips$HHTYPE); summary(enumTrips$HHVTYPE); summary(enumTrips$vehModel)
summary(enumTrips$rowColumn); summary(enumTrips$serial); summary(enumTrips$indexLoc)
## -- Merge income to enumTrips & review high/low income work trips -- ##
popsyn[,indexLoc:=.I]
popinc <- popsyn[,list(indexLoc,income)]
setkey(popinc,indexLoc); setkey(enumTrips,indexLoc)
enumTrips <- enumTrips[popinc]; nrow(enumTrips)
cat("  --> ",nrow(enumTrips[income<regmed & trip2>0]),"records where HH income is under the regional median but there are high income work trips",fill=T)
cat("  --> ",nrow(enumTrips[income>=regmed & trip1>0]),"records where HH income is above the regional median but there are low income work trips",fill=T)
chk <- enumTrips[serial==0]; nrow(chk)
chk2 <- enumTrips[indexLoc==113]
chk3 <- enumTrips[indexLoc==3729002]
## -- Review HI_HHENUM_IN file -- ##
mdt <- fread(in3); nrow(mdt)
setnames(mdt,c("V3"),c("serial"))
summary(mdt$V1); summary(mdt$V2); summary(mdt$serial)
#====================================================================================
## -- Determine frequency of Households being selected -- ##
setwd(inDir1)
wgt <- fread(in6)
wgt <- wgt[!duplicated(sampno),list(sampno,wtperfin)]
setnames(wgt,c("sampno"),c("serial"))
setkey(wgt,serial); setkey(enumTrips,serial)
enumTrips <- merge(enumTrips,wgt,by="serial",all.x=T); nrow(enumTrips)
#
hhUsed <- enumTrips[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]	## -- HHs used in trip enumeration
hhUsed[,wgtRatio:=Obs/wtperfin]											## -- ratio of number of times selected/ survey weight
cat("  --> In a representative sample each household would be used",round(nrow(enumTrips)/nrow(mdt)),"times",fill=T)
summary(hhUsed$Obs)
summary(hhUsed$wtperfin)
summary(hhUsed$wgtRatio)
#
s1 <- enumTrips[wfh==0]
hhUsedNonW <- s1[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]		## -- HHs used in trip enumeration (NON-WFH)
hhUsedNonW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Non-Work from Home households",fill=T)
summary(hhUsedNonW$Obs)
summary(hhUsedNonW$wtperfin)
summary(hhUsedNonW$wgtRatio)
cat("  ----> Share of Non-Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedNonW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedNonW),fill=T)
#
s2 <- enumTrips[wfh==1]
hhUsedW <- s2[,.(Obs=.N,wtperfin=mean(wtperfin)),by=.(serial)]			## -- HHs used in trip enumeration (WFH)
hhUsedW[,wgtRatio:=Obs/wtperfin]										## -- ratio of number of times selected/ survey weight
cat("  --> Work from Home households",fill=T)
summary(hhUsedW$Obs)
summary(hhUsedW$wtperfin)
summary(hhUsedW$wgtRatio)
cat("  ----> Share of Work from Home households where 0.5<=wgtRatio<=1.5:",nrow(hhUsedW[wgtRatio>=0.5 & wgtRatio<=1.5])/nrow(hhUsedW),fill=T)
#
## -- Households not selected -- ##
setkey(hhUsed,serial); setkey(wgt,serial)
notSelected <- merge(wgt,hhUsed,by="serial",all.x=T); nrow(notSelected)
notSelected <-  notSelected[is.na(Obs)]
cat("  --> ",nrow(notSelected),"households were not selected in the enumeration",fill=T)
setwd(baseDir)
## -- Verify zero-worker HHS have not been selected as WFH HHs -- ##
wfhStatus <- fread(in1b); nrow(wfhStatus)
setnames(wfhStatus,c("V1","V2","V3","V4"),c("pserial2","wfhFlag","wfhWkrs","tcNot"))
wfhStatus[,indexLoc:=.I]
setkey(wfhStatus,indexLoc); setkey(popsyn,indexLoc)
review <- popsyn[wfhStatus]
badWfh <- review[wfhFlag>0 & workers==0]; nrow(badWfh)
## -- Review HHID_wfh2 file -- ##
setwd(baseDir)
wfhChoice <- fread(in4); nrow(wfhChoice)
summary(wfhChoice$V1); summary(wfhChoice$V2)
## -- Review HHID_wfh1 file -- ##
wfhChoice1 <- fread(in5); nrow(wfhChoice1)
summary(wfhChoice1$V1); summary(wfhChoice1$V2); summary(wfhChoice1$V3)
#====================================================================================
## -- Summarize types of trips -- ##
enumTrips[,wrkTrips:=trip1+trip2+trip3+trip4+trip5+trip6+trip7+trip8+trip9+trip10+trip11+trip12+trip13+
trip14+trip15+trip16+trip17+trip18+trip19+trip20]																##-- Worker trips
enumTrips[,nonwrkTrips:=trip21+trip22+trip23+trip24+trip25+trip26+trip27+trip28+trip29+trip30+trip31+trip32+trip33]	##-- NonWorker trips
enumTrips[,chdTrips:=trip34+trip35+trip36+trip37+trip38+trip39+trip40+trip41+trip42+trip43+
trip44+trip45+trip46+trip47+trip48+trip49]																		##-- Children 12-15 trips
sumTrips <- enumTrips[,.(wrkTrips=sum(wrkTrips),nonwrkTrips=sum(nonwrkTrips),chdTrips=sum(chdTrips))]
sumTrips[,totalTrips:=wrkTrips+nonwrkTrips+chdTrips]
sumTrips
## -- Review Zero Trip Households -- ##
enumTrips[,allTrips:=wrkTrips+nonwrkTrips+chdTrips]
enumTrips[allTrips==0,zeroHHs:=1L]
enumTrips[allTrips>0,zeroHHs:=0L]
cat(nrow(enumTrips[zeroHHs==1]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",nrow(enumTrips[zeroHHs==1])/nrow(enumTrips),fill=T)
cat("Non-Work From Home:",nrow(enumTrips[zeroHHs==1 & wfh==0]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",
nrow(enumTrips[zeroHHs==1 & wfh==0])/nrow(enumTrips),"(",nrow(enumTrips[wfh==0])/nrow(enumTrips),"of all households",fill=T)
cat("Work From Home:",nrow(enumTrips[zeroHHs==1 & wfh==1]),"Zero Trip Households in Enumerated Data out of ",nrow(enumTrips),"households: ",
nrow(enumTrips[zeroHHs==1 & wfh==1])/nrow(enumTrips),"(",nrow(enumTrips[wfh==1])/nrow(enumTrips),"of all households",fill=T)
